<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TESTE PHASER</title>
    <script src="./lib/phaser-3.55.2.js"></script>
    <style>
      body {
        background-color: black;
        color: white;
      }
    </style>
  </head>
  <body>
    <p id="loading" style="display: none">
      Please wait, loading Phaser build ...
    </p>

    <div id="phaser-example"></div>

    <script id="examplesrc" type="text/javascript">
      class Example extends Phaser.Scene {
        constructor() {
          super();
        }

        preload() {
          this.load.spritesheet(
            "ss-doc",
            "assets/sprites/doc-sheet-32x32.png",
            { frameWidth: 32, frameHeight: 32 }
          );

          this.load.spritesheet(
            "ss-corona",
            "assets/sprites/covid-sheet-32x32.png",
            { frameWidth: 32, frameHeight: 32 }
          );

          this.load.image(
            "tiles",
            "./assets/tilemaps/tiles/drawtiles-spaced.png"
          );
          //this.load.image("car", "./assets/sprites/car90.png");
          //this.load.image("corona", "./assets/sprites/corona.ico");
          this.load.tilemapCSV("map", "./assets/tilemaps/csv/grid.csv");
        }

        create() {
          this.map = this.make.tilemap({
            key: "map",
            tileWidth: 32,
            tileHeight: 32,
          });
          this.props = null;
          this.tileset = this.map.addTilesetImage("tiles", null, 32, 32, 1, 2);
          this.layer = this.map.createLayer(0, this.tileset, 0, 0);

          // this.player = this.add.image(32 + 16, 32 + 16, "corona");
          this.player = this.add.sprite(32 + 16, 32 + 16, "doc");

          this.covy = this.add.sprite(32 + 16, 32 + 16, "covy");

          this.setDocAnims();
          this.setCovyAnims();

          this.player.play("doc-stop-right");
          this.player.lastmove = "doc-stop-right";

          this.covy.play("covy-walk-up");
          this.covy.lastmove = null;

          const pm = this.playerMovement;
          this.input.keyboard.on("keydown", pm);
          this.input.keyboard.on("keyup", pm);

          // const enemies = this.physics.add.group();
          // enemies.create(32+16, 32+16 , "enemy");

          this.timedEvent = this.time.addEvent({
            delay: 300,
            callback: this.moveEnemies,
            callbackScope: this,
            loop: true,
          });
        }

        setCovyAnims() {
          this.anims.create({
            key: "covy-walk-left",
            frames: this.anims.generateFrameNumbers("ss-corona", {
              frames: [0, 2, 0, 2, 0, 3, 0, 2],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "covy-walk-right",
            frames: this.anims.generateFrameNumbers("ss-corona", {
              frames: [4, 6, 4, 6, 4, 7, 4, 6],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "covy-walk-down",
            frames: this.anims.generateFrameNumbers("ss-corona", {
              frames: [
                12, 14, 12, 14, 12, 19, 12, 14, 12, 15, 12, 14, 12, 19, 12, 14,
              ],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "covy-walk-up",
            frames: this.anims.generateFrameNumbers("ss-corona", {
              frames: [20, 21, 22, 21],
            }),
            frameRate: 4,
            repeat: -1,
          });
        }

        setDocAnims() {
          this.anims.create({
            key: "doc-walk-right",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [0, 1, 2],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "doc-stop-right",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [1],
            }),
            frameRate: 4,
            repeat: 0,
          });

          this.anims.create({
            key: "doc-walk-left",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [3, 4, 5],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "doc-stop-left",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [4],
            }),
            frameRate: 4,
            repeat: 0,
          });

          this.anims.create({
            key: "doc-walk-down",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [6, 7, 8],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "doc-stop-down",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [7],
            }),
            frameRate: 4,
            repeat: 0,
          });

          this.anims.create({
            key: "doc-walk-up",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [9, 10, 11],
            }),
            frameRate: 4,
            repeat: -1,
          });

          this.anims.create({
            key: "doc-stop-up",
            frames: this.anims.generateFrameNumbers("ss-doc", {
              frames: [10],
            }),
            frameRate: 4,
            repeat: 0,
          });
        }

        playerMovement(event) {
          console.log("keydown-arguments:", arguments);
          console.log("keydown-event:", event);

          if (event.type == "keyup") {
            switch (this.scene.player.lastmove) {
              case "doc-walk-left":
                this.scene.player.play("doc-stop-left");
                this.scene.player.lastmove = "doc-stop-left";
                break;
              case "doc-walk-right":
                this.scene.player.play("doc-stop-right");
                this.scene.player.lastmove = "doc-stop-right";
                break;
              case "doc-walk-down":
                this.scene.player.play("doc-stop-down");
                this.scene.player.lastmove = "doc-stop-down";
                break;
              case "doc-walk-up":
                this.scene.player.play("doc-stop-up");
                this.scene.player.lastmove = "doc-stop-up";
                break;
            }
          } else if (event.type == "keydown") {
            switch (event.key) {
              case "ArrowLeft":
              case "a":
                var tile = this.scene.layer.getTileAtWorldXY(
                  this.scene.player.x - 32,
                  this.scene.player.y,
                  true
                );
                if (tile.index === 2) {
                  //  Blocked, we can't move
                } else {
                  this.scene.player.x -= 32;
                  if (this.scene.player.lastmove !== "doc-walk-left") {
                    this.scene.player.play("doc-walk-left");
                    this.scene.player.lastmove = "doc-walk-left";
                  }
                  //player.angle = 180;
                }
                break;

              case "ArrowRight":
              case "d":
                var tile = this.scene.layer.getTileAtWorldXY(
                  this.scene.player.x + 32,
                  this.scene.player.y,
                  true
                );

                if (tile.index === 2) {
                  //  Blocked, we can't move
                } else {
                  this.scene.player.x += 32;
                  if (this.scene.player.lastmove !== "doc-walk-right") {
                    this.scene.player.play("doc-walk-right");
                    this.scene.player.lastmove = "doc-walk-right";
                  } //player.angle = 0;
                }
                break;

              case "ArrowDown":
              case "s":
                var tile = this.scene.layer.getTileAtWorldXY(
                  this.scene.player.x,
                  this.scene.player.y + 32,
                  true
                );

                if (tile.index === 2) {
                  //  Blocked, we can't move
                } else {
                  this.scene.player.y += 32;
                  if (this.scene.player.lastmove !== "doc-walk-down") {
                    this.scene.player.play("doc-walk-down");
                    this.scene.player.lastmove = "doc-walk-down";
                  }
                  //player.angle = 90;
                }
                break;
              case "ArrowUp":
              case "w":
                var tile = this.scene.layer.getTileAtWorldXY(
                  this.scene.player.x,
                  this.scene.player.y - 32,
                  true
                );

                if (tile.index === 2) {
                  //  Blocked, we can't move
                } else {
                  this.scene.player.y -= 32;
                  if (this.scene.player.lastmove !== "doc-walk-up") {
                    this.scene.player.play("doc-walk-up");
                    this.scene.player.lastmove = "doc-walk-up";
                  }
                  //player.angle = -90;
                }
                break;
            }
          }
        }

        getNextMove(movs, lastmove) {
          if (Math.floor(Math.random() * 16) && movs.indexOf(lastmove) >= 0) {
            return lastmove;
          }

          return movs[Math.floor(Math.random() * movs.length)];
        }

        getTileIndexByOffset(obj, x, y) {
          return this.layer.getTileAtWorldXY(obj.x + x, obj.y + y, true).index;
        }

        moveEnemies() {
          var movs = [];
          const offset = 32;

          if (this.getTileIndexByOffset(this.covy, 0, offset) !== 2) {
            movs.push("down");
          }
          if (this.getTileIndexByOffset(this.covy, 0, -offset) !== 2) {
            movs.push("up");
          }
          if (this.getTileIndexByOffset(this.covy, -offset, 0) !== 2) {
            movs.push("left");
          }
          if (this.getTileIndexByOffset(this.covy, offset, 0) !== 2) {
            movs.push("right");
          }

          var nextMove = this.getNextMove(movs, this.covy.lastmove);

          switch (nextMove) {
            case "left":
              this.covy.x -= offset;
              this.covy.play("covy-walk-left");
              (this.covy.lastmove != "left") ? this.covy.play("covy-walk-left") : null ;
              break;
            case "right":
              this.covy.x += offset;
              this.covy.play("covy-walk-right");
              (this.covy.lastmove != "right") ? this.covy.play("covy-walk-right") : null ;
              break;
            case "down":
              this.covy.y += offset;
              this.covy.play("covy-walk-down");
              (this.covy.lastmove != "down") ? this.covy.play("covy-walk-down") : null ;
              break;
            case "up":
              this.covy.y -= offset;
              (this.covy.lastmove != "up") ? this.covy.play("covy-walk-up") : null ;
              break;
          }

          this.covy.lastmove = nextMove;
          
          console.log(nextMove);
        }

        update() {}
      }

      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: "phaser-example",
        pixelArt: true,
        backgroundColor: "#1a1a2d",
        scene: [Example],
        physics: {
          default: "arcade",
          arcade: {
            debug: true,
            gravity: { y: 0 },
          },
        },
      };

      const game = new Phaser.Game(config);
    </script>
  </body>
</html>
